# docker box definition
#box: maven:3.5.0
# # defining the dev pipeline

dev:
  box: "maven:3.5.0"
  steps:
    - script:
        code: |
            export http_proxy=http://www-proxy.us.oracle.com:80
            export https_proxy=http://www-proxy.us.oracle.com:80
        name: Exporting_proxy
    - xenoterracide/maven:
        goals: package
        settings: settings.xml

build:
   box: maven:3.5.0
   steps:
      - script:
            name: provide chance for deployment
            code: |
             export ORG_SOURCE=$WERCKER_SOURCE_DIR  
      - xenoterracide/maven:
         goals: package
      - script:
            name: copy artifacts
            code: mkdir $WERCKER_WAR
            code: cp target/CounterWebApp.war $WERCKER_OUTPUT_DIR
            code: cp -R target $WERCKER_OUTPUT_DIR
#            code: cp target/CounterWebApp.war $WERCKER_OUTPUT_DIR

maven-test: 
  box: "maven:3.5.0"
  steps: 
    - script: 
        name: "copy artifacts"
#        code: "cp $WERCKER_WAR/CounterWebApp.war $WERCKER_OUTPUT_DIR"
        code: cp $WERCKER_ROOT/pom.xml $WERCKER_OUTPUT_DIR
#        code: "cp $WERCKER_OUTPUT_DIR/pom.xml $WERCKER_OUTPUT_DIR"
    - xenoterracide/maven: 
      type: "maven test"
      goals: test
    
push-tomcat-to-docker: 
  box: "tomcat:7.0"
  steps: 
    - internal/docker-push: 
        password: $DOCKER_PASSWORD
        registry: "https://registry.hub.docker.com"
        repository: sachinapatil/counterwebapp
        tag: prod-release-1.0.0
        username: $DOCKER_USERNAME

push-war-to-docker: 
  box: "busybox:latest"
  steps: 
    - script: 
        code: |
            find . -type f -name CounterWebApp.war    
            mkdir /app
            cp  $WERCKER_SOURCE_DIR/target/CounterWebApp.war /app
            cp $ORG_SOURCE/CounterWebApp.war /app    
        name: "copy war file"
    - internal/docker-push: 
        cmd: "cp CounterWebApp.war /app && tail -f /dev/null"
        password: $DOCKER_PASSWORD
        registry: "https://registry.hub.docker.com"
        repository: sachinapatil/counterwebapp
        tag: war-container-1.0.0
        username: $DOCKER_USERNAME
